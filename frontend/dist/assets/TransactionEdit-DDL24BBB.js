var t=(t,a,e)=>new Promise(((s,l)=>{var n=t=>{try{i(e.next(t))}catch(a){l(a)}},d=t=>{try{i(e.throw(t))}catch(a){l(a)}},i=t=>t.done?s(t.value):Promise.resolve(t.value).then(n,d);i((e=e.apply(t,a)).next())}));import{_ as a,u as e,C as s,r as l,p as n,o as d,b as i,d as o,e as r,g as c,w as u,A as p,n as v,t as b,i as m,F as _,k as y,l as f,f as k,m as g}from"./index-CXKZenoA.js";const h={class:"card","data-testid":"transaction-edit-container"},w={class:"card-header d-flex justify-content-between align-items-center"},q={class:"card-body"},x={class:"row mb-4"},U={class:"col-md-3"},V={class:"invalid-feedback","data-testid":"transaction-date-error"},C={class:"col-md-3"},F={class:"invalid-feedback","data-testid":"stock-code-error"},E={class:"col-md-3"},$={class:"invalid-feedback","data-testid":"transaction-code-error"},j={class:"col-md-3"},A={class:"invalid-feedback","data-testid":"transaction-type-error"},L={class:"mb-4"},I={class:"border rounded p-3","data-testid":"transaction-details-container"},T=["data-testid"],N={class:"col-md-5"},P=["data-testid"],z=["onUpdate:modelValue","data-testid"],B={class:"col-md-5"},H=["data-testid"],M=["onUpdate:modelValue","data-testid"],S=["data-testid"],D={class:"col-md-2 d-flex align-items-end"},G=["onClick","disabled","data-testid"],J={class:"mb-4"},K={class:"border rounded p-3","data-testid":"fees-container"},O={class:"row g-3"},Q={class:"col-md-4"},R={class:"col-md-4"},W={class:"col-md-4"},X={class:"col-md-4"},Y={class:"col-md-4"},Z={class:"d-flex justify-content-center gap-2"},tt=["disabled"],at={key:0,class:"spinner-border spinner-border-sm me-1"},et=a({__name:"TransactionEdit",setup(a){const et=e(),st=s(),lt=l(!1),nt=l({}),dt=l({transaction_date:"",stock_code:"",stock_name:"",transaction_code:"",transaction_type:"",details:[{quantity:null,price:null}],broker_fee:0,transaction_levy:0,stamp_duty:0,trading_fee:0,deposit_fee:0,market:"",prev_quantity:0,prev_cost:0,prev_avg_cost:0,current_quantity:0,current_cost:0,current_avg_cost:0}),it=()=>t(this,null,(function*(){try{const t=yield g.get(`/api/stock/transactions/${st.params.id}`);if(!t.data.success)throw new Error(t.data.message||"加载交易记录失败");const a=t.data.data;if(!a)throw new Error("交易记录不存在");dt.value={transaction_date:a.transaction_date,stock_code:a.stock_code,stock_name:a.stock_name,transaction_code:a.transaction_code,transaction_type:a.transaction_type.toLowerCase(),details:a.details&&a.details.length>0?a.details:[{quantity:a.total_quantity,price:a.total_amount/a.total_quantity}],broker_fee:a.broker_fee||0,transaction_levy:a.transaction_levy||0,stamp_duty:a.stamp_duty||0,trading_fee:a.trading_fee||0,deposit_fee:a.deposit_fee||0,market:a.market,prev_quantity:a.prev_quantity||0,prev_cost:a.prev_cost||0,prev_avg_cost:a.prev_avg_cost||0,current_quantity:a.current_quantity||0,current_cost:a.current_cost||0,current_avg_cost:a.current_avg_cost||0}}catch(t){throw ct(t.message||"加载交易记录失败，请稍后重试","danger"),t}})),ot=()=>t(this,null,(function*(){var t,a;try{if(!(()=>{try{nt.value={};let t=!0;return dt.value.details.forEach(((a,e)=>{(!a.price||a.price<=0)&&(nt.value[`price_${e}`]="请输入有效的价格",t=!1)})),t}catch(t){return!1}})()||lt.value)return;lt.value=!0;const t=dt.value.details.reduce(((t,a)=>t+(parseFloat(a.quantity)||0)),0),a=dt.value.details.reduce(((t,a)=>t+(parseFloat(a.quantity)||0)*(parseFloat(a.price)||0)),0),e={transaction_date:dt.value.transaction_date,stock_code:dt.value.stock_code,transaction_code:dt.value.transaction_code,transaction_type:dt.value.transaction_type.toLowerCase(),details:dt.value.details.map((t=>({quantity:parseFloat(t.quantity)||0,price:parseFloat(t.price)||0}))),total_quantity:t,total_amount:a,broker_fee:parseFloat(dt.value.broker_fee)||0,transaction_levy:parseFloat(dt.value.transaction_levy)||0,stamp_duty:parseFloat(dt.value.stamp_duty)||0,trading_fee:parseFloat(dt.value.trading_fee)||0,deposit_fee:parseFloat(dt.value.deposit_fee)||0,market:dt.value.market},s=yield g.put(`/api/stock/transactions/${st.params.id}`,e);if(!s.data.success)throw new Error(s.data.message||"操作失败");ct("交易记录更新成功","success"),et.back()}catch(e){ct((null==(a=null==(t=e.response)?void 0:t.data)?void 0:a.message)||e.message||"更新失败，请稍后重试","danger")}finally{lt.value=!1}})),rt=()=>{dt.value.details.push({quantity:null,price:null})},ct=(t,a="danger")=>{const e=document.getElementById("toast-container")||(()=>{const t=document.createElement("div");return t.id="toast-container",t.className="position-fixed top-0 end-0 p-3",t.style.zIndex="1050",document.body.appendChild(t),t})(),s=document.createElement("div");s.className=`toast align-items-center text-white bg-${a} border-0`,s.setAttribute("role","alert"),s.setAttribute("aria-live","assertive"),s.setAttribute("aria-atomic","true"),s.innerHTML=`\n    <div class="d-flex">\n      <div class="toast-body">\n        ${t}\n      </div>\n      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>\n    </div>\n  `,e.appendChild(s);new bootstrap.Toast(s).show(),s.addEventListener("hidden.bs.toast",(()=>{s.remove()}))};return n((()=>dt.value.transaction_type),(t=>{"buy"===t&&(dt.value.stamp_duty=0)})),d((()=>t(this,null,(function*(){try{yield it()}catch(t){ct("加载交易记录失败，请稍后重试","danger")}})))),(t,a)=>(o(),i("div",h,[r("div",w,[a[11]||(a[11]=r("h5",{class:"mb-0","data-testid":"transaction-edit-title"},"编辑交易记录",-1)),r("button",{class:"btn btn-outline-secondary btn-sm",onClick:a[0]||(a[0]=a=>t.$router.back())}," 返回列表 ")]),r("div",q,[r("form",{onSubmit:c(ot,["prevent"])},[r("div",x,[r("div",U,[a[12]||(a[12]=r("label",{class:"form-label","data-testid":"transaction-date-label"},"交易日期",-1)),u(r("input",{type:"date",class:v(["form-control",{"is-invalid":nt.value.transaction_date}]),"onUpdate:modelValue":a[1]||(a[1]=t=>dt.value.transaction_date=t),readonly:"",disabled:"","data-testid":"transaction-date-input"},null,2),[[p,dt.value.transaction_date]]),r("div",V,b(nt.value.transaction_date),1)]),r("div",C,[a[13]||(a[13]=r("label",{class:"form-label","data-testid":"stock-code-label"},"股票代码",-1)),u(r("input",{type:"text",class:v(["form-control",{"is-invalid":nt.value.stock_code}]),"onUpdate:modelValue":a[2]||(a[2]=t=>dt.value.stock_code=t),readonly:"",disabled:"","data-testid":"stock-code-input"},null,2),[[p,dt.value.stock_code]]),r("div",F,b(nt.value.stock_code),1)]),r("div",E,[a[14]||(a[14]=r("label",{class:"form-label","data-testid":"transaction-code-label"},"交易编号",-1)),u(r("input",{type:"text",class:v(["form-control",{"is-invalid":nt.value.transaction_code}]),"onUpdate:modelValue":a[3]||(a[3]=t=>dt.value.transaction_code=t),readonly:"",disabled:"","data-testid":"transaction-code-input"},null,2),[[p,dt.value.transaction_code]]),r("div",$,b(nt.value.transaction_code),1)]),r("div",j,[a[16]||(a[16]=r("label",{class:"form-label","data-testid":"transaction-type-label"},"买卖",-1)),u(r("select",{class:v(["form-select",{"is-invalid":nt.value.transaction_type}]),"onUpdate:modelValue":a[4]||(a[4]=t=>dt.value.transaction_type=t),disabled:"","data-testid":"transaction-type-input"},a[15]||(a[15]=[r("option",{value:"buy"},"买入",-1),r("option",{value:"sell"},"卖出",-1)]),2),[[m,dt.value.transaction_type]]),r("div",A,b(nt.value.transaction_type),1)])]),r("div",L,[r("div",{class:"d-flex justify-content-between align-items-center mb-2"},[a[17]||(a[17]=r("label",{class:"form-label mb-0","data-testid":"transaction-details-label"},"成交明细",-1)),r("button",{type:"button",class:"btn btn-sm btn-outline-primary",onClick:rt,"data-testid":"add-detail-btn"}," 添加成交记录 ")]),r("div",I,[(o(!0),i(_,null,y(dt.value.details,((t,a)=>(o(),i("div",{key:a,class:"row g-2 mb-2","data-testid":"detail-row-"+a},[r("div",N,[r("label",{class:"form-label","data-testid":"quantity-label-"+a},"数量",8,P),u(r("input",{type:"number",class:"form-control","onUpdate:modelValue":a=>t.quantity=a,"data-testid":"quantity-input-"+a},null,8,z),[[p,t.quantity]])]),r("div",B,[r("label",{class:"form-label","data-testid":"price-label-"+a},"价格",8,H),u(r("input",{type:"number",class:v(["form-control",{"is-invalid":nt.value[`price_${a}`]}]),"onUpdate:modelValue":a=>t.price=a,step:"0.001","data-testid":"price-input-"+a},null,10,M),[[p,t.price]]),r("div",{class:"invalid-feedback","data-testid":"price-error-"+a},b(nt.value[`price_${a}`]),9,S)]),r("div",D,[r("button",{type:"button",class:"btn btn-outline-danger w-100",onClick:t=>(t=>{dt.value.details.length>1&&dt.value.details.splice(t,1)})(a),disabled:1===dt.value.details.length,"data-testid":"remove-detail-btn-"+a}," 删除 ",8,G)])],8,T)))),128))])]),r("div",J,[a[23]||(a[23]=r("label",{class:"form-label","data-testid":"fees-label"},"费用明细",-1)),r("div",K,[r("div",O,[r("div",Q,[a[18]||(a[18]=r("label",{class:"form-label","data-testid":"broker-fee-label"},"经纪佣金",-1)),u(r("input",{type:"number",class:"form-control","onUpdate:modelValue":a[5]||(a[5]=t=>dt.value.broker_fee=t),step:"0.01","data-testid":"broker-fee-input"},null,512),[[p,dt.value.broker_fee]])]),r("div",R,[a[19]||(a[19]=r("label",{class:"form-label","data-testid":"transaction-levy-label"},"交易征费",-1)),u(r("input",{type:"number",class:"form-control","onUpdate:modelValue":a[6]||(a[6]=t=>dt.value.transaction_levy=t),step:"0.01","data-testid":"transaction-levy-input"},null,512),[[p,dt.value.transaction_levy]])]),r("div",W,[a[20]||(a[20]=r("label",{class:"form-label","data-testid":"stamp-duty-label"},"印花税",-1)),u(r("input",{type:"number",class:"form-control","onUpdate:modelValue":a[7]||(a[7]=t=>dt.value.stamp_duty=t),step:"0.01","data-testid":"stamp-duty-input"},null,512),[[p,dt.value.stamp_duty]])]),r("div",X,[a[21]||(a[21]=r("label",{class:"form-label","data-testid":"trading-fee-label"},"交易费",-1)),u(r("input",{type:"number",class:"form-control","onUpdate:modelValue":a[8]||(a[8]=t=>dt.value.trading_fee=t),step:"0.01","data-testid":"trading-fee-input"},null,512),[[p,dt.value.trading_fee]])]),r("div",Y,[a[22]||(a[22]=r("label",{class:"form-label","data-testid":"deposit-fee-label"},"存入证券费",-1)),u(r("input",{type:"number",class:"form-control","onUpdate:modelValue":a[9]||(a[9]=t=>dt.value.deposit_fee=t),step:"0.01","data-testid":"deposit-fee-input"},null,512),[[p,dt.value.deposit_fee]])])])])]),r("div",Z,[r("button",{type:"button",class:"btn btn-secondary",onClick:a[10]||(a[10]=a=>t.$router.back()),"data-testid":"cancel-btn"}," 取消 "),r("button",{type:"submit",class:"btn btn-primary",disabled:lt.value,"data-testid":"save-btn"},[lt.value?(o(),i("span",at)):f("",!0),a[24]||(a[24]=k(" 保存修改 "))],8,tt)])],32)])]))}},[["__scopeId","data-v-4bbcefdc"]]);export{et as default};
